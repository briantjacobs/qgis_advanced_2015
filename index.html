<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="description" content="Qgis advanced 2015 : NICAR 2015 QGIS advanced class notes">

    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">

    <title>Qgis advanced 2015</title>
  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <a id="forkme_banner" href="https://github.com/mikejcorey/qgis_advanced_2015">View on GitHub</a>

          <h1 id="project_title">NICAR 2015: Mapping 2</h1>
          <h2 id="project_tagline">Manipulating and editing geographic data with QGIS</h2>

            <section id="downloads">
              <a class="zip_download_link" href="https://github.com/mikejcorey/qgis_advanced_2015/zipball/gh-pages">Download this project as a .zip file</a>
              <a class="tar_download_link" href="https://github.com/mikejcorey/qgis_advanced_2015/tarball/gh-pages">Download this project as a tar.gz file</a>
            </section>
        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">

<h3>Earthquakes in Oklahoma</h3>

<p>Did you know there were more earthquakes in Oklahoma than in California in 2014? That's pretty scary. But the quakes were concentrated in a few key areas. We want to make a map to show who is experiencing the most earthquakes, and will use data joins, reprojection and hex binning to make it happen. Finally, we'll simplify some of our spatial data so it's more ready to use on the big, bad Internet.</p>

<h3>Open earthquakes shapefile</h3>

<p>Click the <img class="button-image" src="images/addvectorbutton.jpg"/> button to add a new vector layer.</p>

<p>Click "browse" to choose a shapefile.</p>

<img class="viz-aid" src="images/addvector2.jpg"/>

<p>Our first dataset is a shapefile of earthquake epicenters from the ANSS catalog. You can find the zipped shapefile in the "data" folder of the project. A shapefile is actually several files with the same name and different extensions. Choose <code>ANSS_2014_US_minimal.shp</code>:</p>

<img class="viz-aid" src="images/addvector3.jpg"/>

<p>Then click "Open." By default you'll see the full extent of the layer, which may look a bit confusing because the Aleutian Islands cross the International Dateline. So use the <img src="images/zoombutton.jpg"/> zoom button to zoom into the contintental United States (the biggest blob).</p>

<img class="viz-aid" src="images/quakesadded.jpg"/>

<p>We can see what other columns besides the epicenter we have by showing the attribute table. RIght-click on the layer in the Layers panel to select "Open attribute table."</p>

<img class="viz-aid" src="images/showattributetable1.jpg"/>

<p>When we open the attribute table, there's not much there beyond the spatial information, just a primary key field and an <code>event_id</code> field.</p>

<img class="viz-aid" src="images/showattributetable2.jpg"/>

<p>This is an extreme example (which is entirely contrived on my part) of a common problem: you have spatial data in one table or shapefile, and another attribute you want to visualize spatially in a different file.

<h3>Open CSV with more data</h3>

<p>In this case, we have data about when the earthquake occurred, magnitude and depth in another CSV. We can join the two datasets because both datasets have a column we can join on: <code>event_id</code> in our shapefile, and <code>catalog_event_id</code> in our CSV file, called <code>ANSS_quake_stats.csv</code>.

<p>Use the <img src="images/addcsv1.jpg"/> button in the left rail of QGIS to add a delimited text layer.</p>

<img class="viz-aid" src="images/addcsv2.jpg"/>

<p>Choose the csv file and click "Open" to bring up a screen with more import options:</p>

<img class="viz-aid" src="images/addcsv3.jpg"/>

<p>The only option to change in this case is to select "No geometry (attribute only table)," since there is no spatial information in this csv. Then click OK. Nothing on the map will change, but there will be a new layer in the Layers panel, <code>ANSS_quake_stats</code>.<p>

<img class="viz-aid" src="images/addcsv4.jpg"/>

<h3>Join shapefile and CSV</h3>

<p>Now we'll create a join. To start, right-click on the shapefile layer (<code>ANSS_2014_US_minimal</code>) --- <strong>NOT the CSV layer</strong> -- and choose "Properties."</p>

<img class="viz-aid" src="images/layer_properties.jpg"/>

<p>Now click the <img src="images/joinbutton.jpg"/> join button in the left menu of the popup, then click the <img src="images/addjoinlayer.jpg"/> button to create a new join.</p>

<p>Now we'll tell QGIS what we want to join and how. For "Join layer," choose our CSV file. And then tell QGIS which two fields are the same in the tables: <code>catalog_event_id</code> in the csv, and <code>event_id</code> in the original shapefile.</p>

<img class="viz-aid" src="images/joindetails.jpg"/>

<p>Click "OK" in the popup, then click "OK" again to close the layer properties.</p>

<p>Let's check our work by opening up the attribute table again. If we did the join correctly, you should see data in the newly joined columns, like so:</p>

<img class="viz-aid" src="images/joined_attributes.jpg"/>

<p>If you see a bunch of NULL values in the joined columns, it likely means you joined on the wrong fields.</p>

<h3>Save joined data as new shapefile</h3>

<p>Even though our shapefile and CSV are now joined, we can't do fun stuff like filter by attributes in the joined CSV, like magnitude or date. So we'll save a new copy of the shapefile with the joined attributes. Right-click on the shapefile layer and click "Save as."</p>

<img class="viz-aid" src="images/save_as_joined_pre.jpg"/>

<p>There's a few things to make sure we're doing right here. First, click "Browse" to tell QGIS where to save the new file, which you should call <code>ANSS_2014_US_joined.shp</code> so we're all on the same page. For "Format" we want <code>ESRI Shapefile</code>. For CRS (coordinate reference system), we want <code>Layer CRS</code>, and in the box below it should say <code>WGS 84</code>. WGS 84 means that our coordinates are in straight latitude/longitude pairs and are not <a href="https://source.opennews.org/en-US/learning/choosing-right-map-projection/" target="_blank">projected</a>. We'll mess with this more in a minute, but as long as your popup matches this click "OK."</p>

<img class="viz-aid" src="images/save_as_joined.jpg"/>

<p>Great! Now we have a single shapefile with all of our earthquake data. Let's filter! Right-click on the <code>ANSS_2014_joined</code> layer and click <code>Filter</code>:</p>

<img class="viz-aid" src="images/joinedfilterohnobad.jpg"/>

<p>Hey! Where are my hard-won event_date, magnitude and depth columns?!</p>

<h3>Zounds! Column shenanigans!</h3>

<p>What happened here? If you recall, when we did our data join, the new columns had the csv layer name pre-pended to them. When we saved the joined file as a new shapefile, the column headers got truncated to the first few characters, which are clearly unhelpful.</p>

<p>This isn't really QGIS's fault, but has more to do with the nature of shapefiles. The data component of a shapefile is stored as a DBF file, and DBF column headers can be a maximum of 10 characters long. This made sense long ago when memory was more precious, but it's stupid nowadays. Still, it is reality and we shall endeavor to practice professionalism and forbearance.</p>

<p>Can we fix it? Yes we can!</p>

<h3>Installing the Table Manager plugin</h3>

<p>It's a little silly that we have to install a plugin to change column names, but we are endeavoring to practice professionalism and forbearance, and installing plugins is easy:</p>

<p>Click <code>Plugins > Manage and Install Plugins</code>.</p>

<img class="viz-aid" src="images/manageplugins1.jpg"/>

<p> Search for "table" in the search box, and choose the <code>Table Manager</code> plugin:</p>

<img class="viz-aid" src="images/manageplugins2.jpg"/>

<p>Now click "Install plugin."</p>

<h3>Fix column names</h3>

<p>With the plugin installed, you should see a <img src="images/tablemanagerbutton.jpg"/> button in your left rail. Select the joined-and-saved layer (<code>ANSS_2014_US_joined</code>), and click the <img src="images/tablemanagerbutton.jpg"/>button.</p>

<p>We are presented with a list of columns in our layer. Luckily for our sanity, QGIS does preserve the column order from the original join, so you can use the order to extrapolate which column is which. (That said, you should always verify the results if you're using this data in battle.)</p>

<img class="viz-aid" src="images/rename_columns1.jpg"/>

<p>Click "Rename" to change each column name, like so:</p>

<img class="viz-aid" src="images/rename_columns2.jpg"/>

<p>Click "Save" to confirm the new column headers and re-save the shapefile.</p>

<h3>Open Oklahoma counties</h3>

<p>Now we turn to extracting only the earthquakes that occured in Oklahoma from our larger, national dataset. We'll use a shapefile of Oklahoma counties from the Census Bureau to spatially filter our earthquake data.</p>

<h3>Project shapefiles into UTM zone 14N</h3>

<h3>Extract Oklahoma earthquakes</h3>

<h3>Create hexagonal bins</h3>

<h3>How big do you want your bins?</h3>

<h3>Filter out bins with no quakes</h3>

<h3>Color bins by count</h3>

<h3>Simplify county shapefile</h3>

<h3>Export GeoJSON</h3>


      </section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p class="copyright">Qgis advanced 2015 maintained by <a href="https://github.com/mikejcorey">mikejcorey</a></p>
        <p>Published with <a href="http://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>

    

  </body>
</html>
